# SPlayer 完整安装和构建指南

## 📋 目录

1. [系统要求](#系统要求)
2. [安装 Visual Studio](#安装-visual-studio)
3. [配置构建环境](#配置构建环境)
4. [构建项目](#构建项目)
5. [验证安装](#验证安装)
6. [常见问题](#常见问题)

## 系统要求

### 最低要求
- **操作系统**: Windows 7 SP1 或更高版本
- **内存**: 4GB RAM
- **磁盘空间**: 20GB 可用空间
- **处理器**: 1.6 GHz 或更快

### 推荐配置
- **操作系统**: Windows 10/11
- **内存**: 8GB+ RAM
- **磁盘空间**: 50GB+ 可用空间
- **Visual Studio**: 2019 或 2022

## 安装 Visual Studio

### 方法 1: 使用安装助手（推荐）

1. **运行安装助手**:
   ```powershell
   .\install-visual-studio.ps1
   ```

2. **按照提示操作**:
   - 脚本会检测是否已安装 Visual Studio
   - 如果未安装，会打开 Visual Studio Installer
   - 按照屏幕提示完成安装

### 方法 2: 手动安装

1. **下载 Visual Studio Installer**
   - 访问: https://visualstudio.microsoft.com/downloads/
   - 下载 Visual Studio 2022 Community（免费版）

2. **运行安装程序**
   - 双击下载的安装程序
   - 等待 Visual Studio Installer 启动

3. **选择工作负载**
   - 在 "工作负载" 标签页
   - 勾选 **"使用 C++ 的桌面开发"** (Desktop development with C++)
   - 在右侧详细信息中，确保勾选：
     - ✅ MFC 和 ATL 支持
     - ✅ Windows 10 SDK（或 Windows 11 SDK）
     - ✅ MSVC v143 - VS 2022 C++ x64/x86 生成工具

4. **安装**
   - 点击右下角 "安装" 或 "修改"
   - 等待安装完成（可能需要 30-60 分钟）
   - 安装完成后，重启计算机（如提示）

### 方法 3: 命令行安装（高级）

```powershell
# 下载 Visual Studio Installer
$installerUrl = "https://aka.ms/vs/17/release/vs_community.exe"
$installerPath = "$env:TEMP\vs_installer.exe"
Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath

# 安装（静默模式）
& $installerPath --quiet --wait --norestart `
    --add Microsoft.VisualStudio.Workload.NativeDesktop `
    --add Microsoft.VisualStudio.Component.VC.ATLMFC `
    --includeRecommended
```

## 配置构建环境

### 步骤 1: 运行修复脚本

```powershell
cd src\BuildScript
.\fix-build-issues.ps1
```

这会自动：
- ✅ 创建缺失的 key 文件
- ✅ 创建 revision.h
- ✅ 创建输出目录
- ✅ 检查 Visual Studio 安装
- ✅ 检查依赖库

### 步骤 2: 验证环境

脚本会显示：
- [OK] 表示正常
- [X] 表示缺失（需要处理）
- [WARNING] 表示警告（可能影响某些功能）

### 步骤 3: 处理缺失的依赖（可选）

如果缺少 `thirdparty/pkg` 或 `thirdparty/sinet`：

**选项 A**: 跳过依赖构建（如果只需要主程序）
- 这些依赖是可选的
- 主项目可以独立构建

**选项 B**: 获取依赖（如果需要完整功能）
- 从原始仓库获取这些依赖
- 或联系项目维护者

## 构建项目

### 使用改进的构建脚本（推荐）

```batch
cd src\BuildScript
build-fixed.cmd
```

**优点**:
- 自动检测 Visual Studio 版本
- 支持 VS2013-2022
- 更好的错误处理

### 使用原始构建脚本

```batch
cd src\BuildScript
build.cmd
```

**注意**: 需要 Visual Studio 2013

### 在 Visual Studio 中构建

1. 打开 `src\splayer.sln`
2. 选择配置: "Release Unicode"
3. 选择平台: "Win32"
4. 生成 → 生成解决方案 (F7)

## 验证安装

### 检查 Visual Studio 安装

```powershell
# 检查环境变量
$env:VS160COMNTOOLS  # VS2019
$env:VS170COMNTOOLS  # VS2022

# 或运行
.\install-visual-studio.ps1
```

### 检查构建输出

构建成功后，可执行文件位于：
```
src\out\bin\Release Unicode\splayer.exe
```

运行测试：
```batch
cd src\out\bin\Release Unicode
splayer.exe
```

## 常见问题

### Q1: Visual Studio 安装后仍检测不到

**解决方案**:
1. 重启计算机
2. 重新打开 PowerShell/命令提示符
3. 检查环境变量是否设置：
   ```powershell
   [Environment]::GetEnvironmentVariable("VS160COMNTOOLS", "Machine")
   ```
4. 如果为空，手动设置：
   ```powershell
   # 找到 Visual Studio 安装路径
   $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools"
   [Environment]::SetEnvironmentVariable("VS160COMNTOOLS", "$vsPath\", "Machine")
   ```

### Q2: 构建时提示 "找不到 MFC"

**解决方案**:
1. 打开 Visual Studio Installer
2. 点击 "修改"
3. 在 "使用 C++ 的桌面开发" 中
4. 勾选 "MFC 和 ATL 支持"
5. 点击 "修改" 完成安装

### Q3: 构建时提示 "找不到 Windows SDK"

**解决方案**:
1. 在 Visual Studio Installer 中
2. 选择 "单个组件" 标签
3. 搜索 "Windows SDK"
4. 安装最新版本的 Windows 10/11 SDK

### Q4: 构建失败，提示工具集版本错误

**解决方案**:
1. 使用 `build-fixed.cmd`（自动处理）
2. 或手动升级项目文件：
   - 在 Visual Studio 中打开解决方案
   - 右键解决方案 → 重定向项目
   - 选择已安装的 Visual Studio 版本

### Q5: 依赖库缺失导致构建失败

**解决方案**:
- 这些依赖是可选的
- 可以修改构建脚本跳过依赖构建
- 或获取依赖库后重新构建

## 安装检查清单

完成以下检查清单：

- [ ] Visual Studio 已安装
- [ ] "使用 C++ 的桌面开发" 工作负载已安装
- [ ] MFC 和 ATL 支持已安装
- [ ] Windows SDK 已安装
- [ ] 运行 `fix-build-issues.ps1` 无错误
- [ ] 构建脚本可以找到 Visual Studio
- [ ] 项目可以成功构建

## 下一步

安装和构建成功后：

1. **测试运行**: 运行 `src\out\bin\Release Unicode\splayer.exe`
2. **查看文档**: 
   - [现代化实施计划](docs/analysis/现代化实施计划.md)
   - [RFC 文档](docs/rfc/)
3. **开始开发**: 查看源代码结构，开始贡献

## 获取帮助

- **构建问题**: 查看 [BUILD-FIXES.md](docs/BUILD-FIXES.md)
- **安装问题**: 查看本文档的常见问题部分
- **项目问题**: 查看 [README.md](README.md)

## 相关链接

- [Visual Studio 下载](https://visualstudio.microsoft.com/downloads/)
- [Visual Studio 文档](https://docs.microsoft.com/visualstudio/)
- [C++ 开发指南](https://docs.microsoft.com/cpp/)
